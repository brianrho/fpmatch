# Copyright (C) 2021, Brian Ejike, MIT License

import os
import ctypes

# (apparent) size of a single feature file (aka character file) 
# after the sensor processes a single image
FPM_CHAR_SIZE = 256

# size of a single template stored within the sensor's flash library
# this varies from sensor to sensor, each template seems to hold multiple feature files
# one file per image captured either during enrollment or verification
FPM_TEMPLATE_SIZE = 512

# arbitrary score/confidence threshold
FPM_MATCH_THRESHOLD = 50

# userInput is a dump of the sensor's RAM buffer after getting and converting a single image.
# correctMatch is the template in the sensor's flash library taken from the same finger as userInput. 
#
# template1 and template2 are just randomly chosen templates which should be negative matches with userInput.

userInput = [
    0x3, 0x1, 0x59, 0x11, 0x0, 0x0, 0xFF, 0xFE, 0xFF, 0x3E, 0xFC, 0x1E, 0xE0, 0xE, 0xE0, 0x6, 
    0xE0, 0x6, 0xE0, 0x2, 0xC0, 0x2, 0xC0, 0x2, 0xC0, 0x2, 0xC0, 0x0, 0x80, 0x0, 0x80, 0x0, 
    0xC0, 0x0, 0xC0, 0x0, 0xE0, 0x0, 0xE0, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x53, 0x8A, 0x14, 0x3E, 0x3D, 0x8D, 0xD9, 0x3E, 
    0x4F, 0x92, 0x54, 0xDE, 0x3A, 0x1C, 0x59, 0xFE, 0x48, 0xAE, 0x57, 0x3E, 0x62, 0x3A, 0x68, 0xFE, 
    0x60, 0x97, 0x11, 0xDF, 0x57, 0x99, 0x68, 0x1F, 0x1F, 0x20, 0x83, 0x3F, 0x56, 0xA1, 0x94, 0x7F, 
    0x60, 0xA7, 0x52, 0xDF, 0x54, 0x27, 0xA8, 0xDF, 0x63, 0x3E, 0x53, 0xBF, 0x2F, 0x32, 0xC2, 0x5C, 
    0x28, 0xB3, 0xD9, 0xFC, 0x4D, 0x39, 0xEB, 0x6E, 0x54, 0xBA, 0x95, 0xB2, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
]

correctMatch = [
    0x3, 0x1, 0x5F, 0x15, 0x0, 0x0, 0xFF, 0xFE, 0xE0, 0x3E, 0xC0, 0x3E, 0x80, 0x1E, 0x80, 0x1E, 
    0x80, 0xE, 0x0, 0xE, 0x0, 0xE, 0x0, 0xE, 0x0, 0x6, 0x0, 0x6, 0x0, 0x6, 0x0, 0x6, 
    0x0, 0x2, 0x0, 0x2, 0x80, 0x6, 0xC0, 0xE, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3D, 0x8D, 0x12, 0xFE, 0x3E, 0x9A, 0xA9, 0x3E, 
    0x2A, 0xAF, 0x17, 0x7E, 0x13, 0xB3, 0x81, 0xFE, 0xB, 0xB4, 0x59, 0xFE, 0x29, 0x8E, 0x9A, 0x5F, 
    0x4A, 0x10, 0x11, 0x1F, 0x39, 0x14, 0x14, 0x9F, 0x46, 0x18, 0x92, 0x57, 0x53, 0x99, 0xE7, 0x9F, 
    0x20, 0x1B, 0xD9, 0xFF, 0x39, 0xA2, 0x54, 0x3F, 0x37, 0xA8, 0x28, 0xFF, 0x5C, 0x2D, 0x11, 0xFF, 
    0x40, 0x2D, 0x93, 0xBF, 0x57, 0x3C, 0x92, 0x7F, 0x5D, 0x3F, 0xD1, 0x5F, 0x2F, 0xBA, 0x2C, 0xDC, 
    0x45, 0xBA, 0xE8, 0x7C, 0x37, 0x3A, 0x15, 0x75, 0x45, 0xBE, 0x93, 0x9D, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x3, 0x1, 0x59, 0x13, 0x0, 0x0, 0xFF, 0xFE, 0xFC, 0x3E, 0xF0, 0xE, 0xE0, 0x6, 0xE0, 0x6, 
    0xE0, 0x2, 0xC0, 0x2, 0xC0, 0x2, 0xC0, 0x0, 0xC0, 0x0, 0xC0, 0x0, 0xC0, 0x0, 0xC0, 0x0, 
    0xC0, 0x0, 0xC0, 0x0, 0xE0, 0x0, 0xE0, 0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x56, 0x8A, 0x93, 0x1E, 0x63, 0x8E, 0x10, 0x9E, 
    0x50, 0x11, 0x95, 0x9E, 0x3A, 0x9A, 0x9A, 0x3E, 0x48, 0x2C, 0x97, 0x5E, 0x42, 0x8C, 0x1A, 0x1F, 
    0x22, 0x1F, 0x3, 0x3F, 0x55, 0xA0, 0x14, 0x7F, 0x4A, 0xB6, 0xEB, 0xFF, 0x56, 0x37, 0x15, 0x5F, 
    0x73, 0x39, 0x52, 0x1F, 0x59, 0x97, 0xE8, 0xDC, 0x2F, 0x30, 0x82, 0x9C, 0x28, 0x31, 0x5A, 0x5C, 
    0x60, 0x15, 0xD1, 0xB5, 0x63, 0x3B, 0x93, 0x9D, 0x60, 0x38, 0x68, 0xBA, 0x54, 0x25, 0xA8, 0xBB, 
    0x5F, 0x25, 0x91, 0xD7, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
    0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0
]

template1 = [
        3, 1, 80, 24, 0, 0, 255, 254, 255, 62, 252, 30, 248, 14, 240, 6,
        224, 6, 192, 6, 192, 6, 128, 6, 128, 6, 128, 6, 128, 2, 0, 2,
        0, 6, 128, 6, 128, 6, 128, 14, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 55, 20, 6, 190, 80, 24, 153, 30,
        67, 155, 156, 126, 31, 30, 197, 62, 66, 162, 90, 158, 107, 174, 210, 254,
        72, 177, 22, 190, 58, 66, 22, 62, 50, 36, 27, 127, 91, 176, 148, 63,
        97, 63, 170, 151, 83, 65, 211, 255, 81, 10, 164, 116, 63, 146, 223, 92,
        25, 178, 4, 125, 19, 178, 156, 221, 25, 39, 68, 218, 25, 37, 28, 155,
        31, 194, 195, 251, 17, 62, 221, 150, 74, 18, 108, 247, 29, 63, 69, 209,
        25, 191, 155, 46, 18, 189, 5, 139, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        3, 1, 83, 21, 0, 0, 255, 254, 255, 254, 255, 30, 252, 14, 248, 6,
        240, 2, 224, 2, 224, 2, 192, 2, 192, 2, 192, 2, 128, 2, 128, 2,
        128, 2, 128, 2, 128, 6, 128, 6, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 83, 15, 219, 222, 56, 18, 134, 158,
        82, 151, 216, 254, 71, 155, 27, 254, 33, 30, 4, 254, 69, 33, 26, 94,
        51, 161, 219, 190, 26, 37, 196, 158, 95, 47, 83, 254, 75, 47, 150, 190,
        17, 183, 68, 30, 61, 64, 86, 62, 36, 183, 90, 127, 87, 64, 20, 191,
        22, 49, 27, 21, 28, 177, 3, 221, 65, 14, 134, 54, 20, 61, 156, 150,
        22, 60, 67, 151, 24, 65, 67, 247, 66, 18, 94, 18, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
]

template2 = [
        3, 1, 86, 22, 0, 0, 255, 254, 254, 62, 252, 30, 240, 6, 224, 6,
        224, 6, 224, 2, 192, 2, 192, 2, 192, 2, 192, 2, 192, 2, 192, 2,
        128, 2, 128, 2, 128, 2, 128, 6, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 64, 140, 225, 126, 55, 22, 134, 222,
        80, 155, 216, 190, 69, 158, 219, 222, 69, 37, 218, 62, 50, 166, 156, 30,
        75, 180, 22, 94, 92, 52, 19, 158, 26, 61, 195, 222, 63, 150, 222, 127,
        33, 161, 69, 95, 23, 181, 219, 247, 38, 56, 131, 95, 39, 188, 218, 191,
        81, 13, 227, 92, 78, 144, 232, 253, 35, 23, 134, 250, 35, 26, 95, 154,
        28, 42, 196, 218, 53, 46, 66, 154, 51, 49, 26, 218, 28, 40, 155, 219,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        3, 1, 82, 21, 0, 0, 255, 254, 252, 254, 240, 30, 224, 14, 192, 14,
        192, 14, 192, 6, 192, 6, 128, 6, 128, 6, 128, 6, 0, 2, 0, 2,
        0, 2, 128, 6, 128, 6, 128, 14, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 65, 153, 24, 62, 55, 156, 219, 158,
        35, 163, 155, 94, 103, 164, 18, 222, 81, 47, 211, 30, 62, 177, 22, 30,
        76, 193, 148, 30, 55, 34, 89, 191, 16, 51, 131, 255, 21, 67, 90, 191,
        41, 21, 198, 60, 47, 20, 94, 189, 37, 46, 154, 58, 36, 172, 66, 91,
        27, 186, 154, 59, 64, 139, 38, 88, 62, 17, 167, 214, 19, 59, 2, 244,
        51, 11, 161, 79, 58, 146, 128, 21, 62, 14, 164, 211, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
]

if __name__ == "__main__":
    # for Python 3.8 and newer
    # need to explicitly add the DLL directory to the process DLL search path
    if "add_dll_directory" in dir(os):
        os.add_dll_directory(os.path.abspath(os.path.join("..", "common")))
        
    # load the DLL
    arth = ctypes.WinDLL('ARTH_DLL')
    
    # assemble database
    database = [correctMatch, template1, template2]
    
    # iterate through database and match user input against each template
    for template in database:
        # match against each feature file within the template
        first = arth.Match2Fp(bytes(userInput), bytes(template))
        second = arth.Match2Fp(bytes(userInput), bytes(template)[FPM_CHAR_SIZE:])
        
        avg_score = (first + second) // 2
        
        print("First: {}, Second: {}, Average: {}".format(first, second, avg_score))

        if score > FPM_MATCH_THRESHOLD:
            print('Templates match.')
        else:
            print('Templates do not match!')
